name: Update KP Index

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download KP index safely
        run: |
          set -x  # –≤–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
          echo "üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å NOAA..."
          STATUS=$(curl -s -w "%{http_code}" -o tmp_kp.json https://services.swpc.noaa.gov/json/planetary_k_index.json)

          echo "–ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å: $STATUS"
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ tmp_kp.json:"
          cat tmp_kp.json || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å tmp_kp.json"

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: NOAA –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å $STATUS"
            exit 1
          fi

          if jq empty tmp_kp.json 2>/dev/null; then
            mv tmp_kp.json docs/planetary_k_index.json
            echo "‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."
          else
            echo "‚ùå –ü–æ–ª—É—á–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON."
            exit 1
          fi

      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git status
          ls -l docs/
          git add docs/planetary_k_index.json
          git commit -m "Update KP index from NOAA" || echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push
